# Det-SAM2 æ¨¡å—ä¾èµ–å…³ç³»å›¾

## ğŸ—ï¸ æ•´ä½“æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨å±‚ (Application Layer)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DetSAM2Pipeline  â”‚  Evaluation Scripts  â”‚  Notebooks â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 ä¸šåŠ¡é€»è¾‘å±‚ (Business Layer)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VideoPostProcessor (å°çƒåœºæ™¯åå¤„ç†)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 æ¨ç†å±‚ (Inference Layer)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VideoProcessor (Det-SAM2æ ¸å¿ƒæ¨ç†)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 æ¨¡å‹å±‚ (Model Layer)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SAM2VideoPredictor    â”‚    YOLOv8 Detector           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 åŸºç¡€å±‚ (Foundation Layer)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PyTorch  â”‚  OpenCV  â”‚  NumPy  â”‚  å…¶ä»–å·¥å…·åº“           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— æ ¸å¿ƒæ¨¡å—ä¾èµ–å…³ç³»

### VideoProcessor (det_sam2_RT.py)
```
VideoProcessor
â”œâ”€â”€ ä¾èµ–æ¨¡å—
â”‚   â”œâ”€â”€ sam2.sam2_video_predictor.SAM2VideoPredictor
â”‚   â”œâ”€â”€ ultralytics.YOLO (YOLOv8æ£€æµ‹å™¨)
â”‚   â”œâ”€â”€ torch, cv2, numpy, pickle
â”‚   â””â”€â”€ sam2.build_sam.build_sam2_video_predictor
â”œâ”€â”€ è¾“å…¥æ¥å£
â”‚   â”œâ”€â”€ video_path (MP4è§†é¢‘æ–‡ä»¶)
â”‚   â”œâ”€â”€ frame_dir (è§†é¢‘å¸§æ–‡ä»¶å¤¹)
â”‚   â””â”€â”€ inference_state (é¢„åŠ è½½è®°å¿†åº“)
â””â”€â”€ è¾“å‡ºæ¥å£
    â”œâ”€â”€ video_segments.pkl (åˆ†å‰²maskå­—å…¸)
    â”œâ”€â”€ special_classes_detection.pkl (ç‰¹æ®Šç±»åˆ«æ£€æµ‹)
    â””â”€â”€ inference_state.pkl (è®°å¿†åº“ä¿å­˜)
```

### VideoPostProcessor (postprocess_det_sam2.py)
```
VideoPostProcessor
â”œâ”€â”€ ä¾èµ–æ¨¡å—
â”‚   â”œâ”€â”€ numpy, cv2, pickle, json
â”‚   â”œâ”€â”€ matplotlib (å¯è§†åŒ–)
â”‚   â””â”€â”€ è‡ªå®šä¹‰å·¥å…·å‡½æ•°
â”œâ”€â”€ è¾“å…¥æ¥å£
â”‚   â””â”€â”€ video_segments.pkl (æ¥è‡ªVideoProcessor)
â””â”€â”€ è¾“å‡ºæ¥å£
    â”œâ”€â”€ è¿›çƒäº‹ä»¶æ£€æµ‹ç»“æœ
    â”œâ”€â”€ ç¢°æ’äº‹ä»¶æ£€æµ‹ç»“æœ
    â”œâ”€â”€ åå¼¹äº‹ä»¶æ£€æµ‹ç»“æœ
    â””â”€â”€ å¯è§†åŒ–æ¸²æŸ“è§†é¢‘
```

### DetSAM2Pipeline (Det_SAM2_pipeline.py)
```
DetSAM2Pipeline
â”œâ”€â”€ ä¾èµ–æ¨¡å—
â”‚   â”œâ”€â”€ VideoProcessor (ç»„åˆå…³ç³»)
â”‚   â”œâ”€â”€ VideoPostProcessor (ç»„åˆå…³ç³»)
â”‚   â”œâ”€â”€ asyncio (å¼‚æ­¥å¤„ç†)
â”‚   â””â”€â”€ threading (å¤šçº¿ç¨‹)
â”œâ”€â”€ è¾“å…¥æ¥å£
â”‚   â”œâ”€â”€ video_source (MP4æ–‡ä»¶æˆ–RTSPæµ)
â”‚   â””â”€â”€ å„ç§é…ç½®å‚æ•°
â””â”€â”€ è¾“å‡ºæ¥å£
    â”œâ”€â”€ å®æ—¶å¤„ç†ç»“æœ
    â””â”€â”€ æœ€ç»ˆäº‹ä»¶æ£€æµ‹æŠ¥å‘Š
```

## ğŸ“Š æ•°æ®æµå›¾è¯¦è§£

### 1. åŸºç¡€æ¨ç†æµç¨‹ (det_sam2_RT.py)
```
è§†é¢‘è¾“å…¥ â†’ å¸§è§£ç  â†’ å¸§ç¼“å†² â†’ æ‰¹é‡å¤„ç†
                         â†“
æ£€æµ‹å™¨(YOLO) â†’ æ¡ä»¶å¸§æ ‡è®° â†’ SAM2æ¨ç† â†’ maskè¾“å‡º
                         â†“
è®°å¿†åº“ç®¡ç† â†’ èµ„æºä¼˜åŒ– â†’ ç»“æœä¿å­˜
```

### 2. å®Œæ•´Pipelineæµç¨‹ (Det_SAM2_pipeline.py)
```
                    è§†é¢‘æµè¾“å…¥
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                   â†“
        VideoProcessor      ç¼“å†²é˜Ÿåˆ—ç®¡ç†
              â†“                   â†“
        åˆ†å‰²maskç”Ÿæˆ        å¼‚æ­¥æ•°æ®ä¼ é€’
              â†“                   â†“
        VideoPostProcessor   ç»“æœèšåˆ
              â†“                   â†“
        äº‹ä»¶æ£€æµ‹ç»“æœ         æœ€ç»ˆè¾“å‡º
```

### 3. è¯„ä¼°æµç¨‹ (eval_det-sam2.py)
```
å‚æ•°ç½‘æ ¼ â†’ æ‰¹é‡æµ‹è¯• â†’ VideoProcessor â†’ VideoPostProcessor
    â†“                                           â†“
é…ç½®ç»„åˆ â†’ å¾ªç¯æ‰§è¡Œ â†’ åˆ†å‰²æ¨ç† â†’ åå¤„ç† â†’ æŒ‡æ ‡è®¡ç®—
    â†“                                           â†“
æœ€ä¼˜å‚æ•° â† ç»“æœåˆ†æ â† æ€§èƒ½è¯„ä¼° â† ç»“æœæ”¶é›† â† JSONè¾“å‡º
```

## ğŸ§© å…³é”®ç»„ä»¶äº¤äº’

### SAM2ä¸æ£€æµ‹å™¨çš„åä½œ
```python
# æ£€æµ‹å™¨æä¾›æ¡ä»¶å¸§
detection_results = yolo_model(frame)
for detection in detection_results:
    bbox = detection.bbox
    sam2_predictor.add_new_mask(frame_idx, bbox)

# SAM2åŸºäºæ¡ä»¶å¸§ä¼ æ’­æ¨ç†
for frame_idx in range(start, end):
    masks = sam2_predictor.propagate_in_video(frame_idx)
```

### è®°å¿†åº“ç®¡ç†æœºåˆ¶
```python
# è®°å¿†åº“çŠ¶æ€ç®¡ç†
inference_state = {
    "images": [],           # è§†é¢‘å¸§ç¼“å­˜
    "masks": {},           # åˆ†å‰²maskå†å²
    "obj_ids": set(),      # å¯¹è±¡IDé›†åˆ
    "frame_idx": 0         # å½“å‰å¸§ç´¢å¼•
}

# åŠ¨æ€å†…å­˜ä¼˜åŒ–
if len(inference_state["images"]) > max_frames:
    # é‡Šæ”¾æ—§å¸§ï¼Œä¿æŒæ’å®šå†…å­˜å ç”¨
    release_old_frames(inference_state)
```

### å¼‚æ­¥å¤„ç†æœºåˆ¶
```python
# Pipelineä¸­çš„å¼‚æ­¥å¤„ç†
async def process_video_stream():
    video_task = asyncio.create_task(video_processing())
    postprocess_task = asyncio.create_task(post_processing())
    
    # å¹¶è¡Œæ‰§è¡Œ
    await asyncio.gather(video_task, postprocess_task)
```

## ğŸ”§ é…ç½®æ–‡ä»¶ä¾èµ–

### SAM2æ¨¡å‹é…ç½®
```
sam2/configs/
â”œâ”€â”€ sam2.1_hiera_t.yaml    # Tinyæ¨¡å‹é…ç½®
â”œâ”€â”€ sam2.1_hiera_s.yaml    # Smallæ¨¡å‹é…ç½®  
â”œâ”€â”€ sam2.1_hiera_b+.yaml   # Base+æ¨¡å‹é…ç½®
â””â”€â”€ sam2.1_hiera_l.yaml    # Largeæ¨¡å‹é…ç½®
```

### æ£€æµ‹å™¨æƒé‡æ˜ å°„
```
det_sam2_inference/det_weights/
â””â”€â”€ train_referee12_960.pt  # å°çƒåœºæ™¯YOLOv8æƒé‡
```

## ğŸ“¦ å¤–éƒ¨ä¾èµ–åº“

### æ·±åº¦å­¦ä¹ æ ˆ
- **PyTorch**: æ ¸å¿ƒæ·±åº¦å­¦ä¹ æ¡†æ¶
- **torchvision**: è§†è§‰å·¥å…·åº“
- **CUDA**: GPUåŠ é€Ÿæ”¯æŒ

### è®¡ç®—æœºè§†è§‰
- **OpenCV**: å›¾åƒå¤„ç†å’Œè§†é¢‘I/O
- **PIL/Pillow**: å›¾åƒå¤„ç†
- **ultralytics**: YOLOv8å®ç°

### æ•°æ®å¤„ç†
- **NumPy**: æ•°å€¼è®¡ç®—
- **Pickle**: åºåˆ—åŒ–å­˜å‚¨
- **JSON**: é…ç½®å’Œç»“æœå­˜å‚¨

### å¯è§†åŒ–å’ŒUI
- **Matplotlib**: ç»“æœå¯è§†åŒ–
- **tqdm**: è¿›åº¦æ¡æ˜¾ç¤º

## ğŸš€ æ‰©å±•æ¥å£

### è‡ªå®šä¹‰æ£€æµ‹å™¨æ¥å£
```python
class CustomDetector:
    def detect(self, frame):
        """è¿”å›æ£€æµ‹ç»“æœ: [bbox, confidence, class_id]"""
        pass
    
    def get_classes(self):
        """è¿”å›ç±»åˆ«åç§°åˆ—è¡¨"""
        pass
```

### è‡ªå®šä¹‰åå¤„ç†å™¨æ¥å£  
```python
class CustomPostProcessor:
    def process(self, video_segments):
        """å¤„ç†åˆ†å‰²ç»“æœï¼Œè¿”å›ä¸šåŠ¡é€»è¾‘ç»“æœ"""
        pass
    
    def visualize(self, results):
        """å¯è§†åŒ–å¤„ç†ç»“æœ"""
        pass
```

### è‡ªå®šä¹‰äº‹ä»¶æ£€æµ‹å™¨
```python
class EventDetector:
    def detect_events(self, trajectories):
        """åŸºäºè½¨è¿¹æ£€æµ‹ç‰¹å®šäº‹ä»¶"""
        pass
    
    def get_event_types(self):
        """è¿”å›æ”¯æŒçš„äº‹ä»¶ç±»å‹"""
        pass
```

---

é€šè¿‡è¿™ä¸ªæ¨¡å—ä¾èµ–å…³ç³»å›¾ï¼Œä½ å¯ä»¥ï¼š
1. å¿«é€Ÿç†è§£å„ç»„ä»¶çš„èŒè´£è¾¹ç•Œ
2. è¿½è¸ªæ•°æ®åœ¨ç³»ç»Ÿä¸­çš„æµè½¬è·¯å¾„  
3. å®šä½éœ€è¦ä¿®æ”¹çš„å…·ä½“æ¨¡å—
4. è®¾è®¡è‡ªå®šä¹‰æ‰©å±•çš„æ¥å£

è¿™äº›æ¶æ„æ–‡ä»¶å°†å¸®åŠ©ä½ å’Œæˆ‘åœ¨åç»­çš„å¼€å‘ä¸­å¿«é€Ÿå®šä½é—®é¢˜å’Œå®ç°æ–°åŠŸèƒ½ã€‚ 